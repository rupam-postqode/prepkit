// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ USERS ============
model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  passwordHash          String   // Argon2 hash
  name                  String
  role                  Role     @default(USER)

  // Profile
  targetCompanies       String[] // ["Google", "Amazon", "Flipkart"]
  experienceLevel       Experience @default(FRESHER)
  preferredLanguage     String   @default("javascript")

  // Subscription
  subscriptionStatus    SubscriptionStatus @default(FREE)
  subscriptionPlan      String?  // "monthly", "yearly", "lifetime"
  subscriptionEndDate   DateTime?

  // Relations
  lessonProgress        LessonProgress[]
  subscriptions         Subscription[]
  feedback              Feedback[]
  videos                Video[]
  jobs                  Job[]
  pathProgress          UserPathProgress[]
  achievements          Achievement[]

  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastLoginAt           DateTime?

  @@index([email])
  @@index([subscriptionStatus])
}

// ============ CONTENT ============
model Module {
  id          String  @id @default(cuid())
  title       String  // "DSA", "Machine Coding", etc.
  slug        String  @unique
  description String
  emoji       String  // üìö, üéØ, üèóÔ∏è, üí¨, üìã
  orderIndex  Int

  chapters    Chapter[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Chapter {
  id                String  @id @default(cuid())
  moduleId          String
  module            Module  @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title             String
  slug              String
  description       String
  orderIndex        Int
  difficultyLevel   Difficulty @default(BEGINNER)
  estimatedHours    Int

  lessons           Lesson[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([moduleId, slug])
  @@index([moduleId])
}

model Lesson {
  id                String  @id @default(cuid())
  chapterId         String
  chapter           Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  title             String
  slug              String
  description       String
  orderIndex        Int

  // Content
  videoUrl          String?  // S3/CloudFront URL
  videoDurationSec  Int?
  markdownContent   String  // Stored in DB or reference S3

  // Notes & Resources
  importantPoints   String? // JSON string of important points array
  commonMistakes    String? // JSON string of common mistakes array
  quickReference    String? // Code examples, formulas, syntax reminders

  premium           Boolean @default(false) // Whether lesson requires subscription

  difficulty        Difficulty

  // Metadata
  publishedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  progress          LessonProgress[]
  practiceLinks     PracticeLink[]
  feedback          Feedback[]
  videos            Video[]
  pathLessons       PathLesson[]

  @@unique([chapterId, slug])
  @@index([chapterId])
  @@index([publishedAt])
}

model LessonProgress {
  id                    String  @id @default(cuid())
  userId                String
  user                  User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  lessonId              String
  lesson                Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  startedAt             DateTime @default(now())
  completedAt           DateTime?

  timeSpentSeconds      Int     @default(0)
  videoWatchedPercent   Int     @default(0) // 0-100
  markdownRead          Boolean @default(false)

  rating                Int?    // 1-5
  notes                 String? // User's personal notes

  updatedAt             DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([completedAt])
}

model PracticeLink {
  id              String   @id @default(cuid())
  lessonId        String
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  platform        Platform // LEETCODE, CODESANDBOX, ALGOEXPERT, HACKERRANK
  problemTitle    String
  problemUrl      String
  difficulty      Difficulty
  orderIndex      Int

  createdAt       DateTime @default(now())

  @@index([lessonId])
}

model Feedback {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  lessonId        String?
  lesson          Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  rating          Int?     // 1-5
  comment         String
  type            FeedbackType // BUG, SUGGESTION, GENERAL

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([lessonId])
  @@index([type])
}

// ============ VIDEOS ============
model Video {
  id              String   @id @default(cuid())
  fileName        String   // Original filename with extension
  originalName    String   // User-uploaded filename
  fileSize        Int      // File size in bytes
  mimeType        String   // MIME type (video/mp4, etc.)
  duration        Int?     // Duration in seconds
  s3Key           String   // S3 object key
  s3Bucket        String   // S3 bucket name
  status          VideoStatus @default(UPLOADED)

  uploadedBy      String   // User ID who uploaded
  user            User     @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  // Optional lesson association
  lessonId        String?
  lesson          Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([uploadedBy])
  @@index([lessonId])
  @@index([status])
}

// ============ SUBSCRIPTIONS & PAYMENTS ============
model Subscription {
  id                      String  @id @default(cuid())
  userId                  String
  user                    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan                    SubscriptionPlan
  status                  SubscriptionStatus

  razorpaySubscriptionId  String? @unique
  razorpayCustomerId      String?

  startDate               DateTime @default(now())
  endDate                 DateTime?

  amount                  Int     // in paise (‚Çπ100 = 10000 paise)
  currency                String  @default("INR")

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  payments                Payment[]

  @@index([userId])
  @@index([status])
  @@index([endDate])
}

model Payment {
  id                      String  @id @default(cuid())
  subscriptionId          String?
  subscription            Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  userId                  String

  razorpayPaymentId       String? @unique
  razorpayOrderId         String

  amount                  Int     // in paise
  currency                String  @default("INR")

  status                  PaymentStatus
  method                  String? // "card", "upi", "netbanking", etc.

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// ============ ENUMS ============
enum Role {
  USER
  ADMIN
}

enum Experience {
  FRESHER
  JUNIOR
  MID
  SENIOR
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
}

enum Difficulty {
  BEGINNER
  EASY
  MEDIUM
  HARD
}

enum Platform {
  LEETCODE
  CODESANDBOX
  ALGOEXPERT
  HACKERRANK
}

enum FeedbackType {
  BUG
  SUGGESTION
  GENERAL
}

enum VideoStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  FAILED
}

enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

// ============ LEARNING PATHS ============
model LearningPath {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String
  emoji       String   @default("üéØ")

  // Path details
  durationWeeks Int    // 4, 12, 16 weeks
  difficulty    Difficulty @default(MEDIUM)
  targetCompanies String[] // ["Google", "Meta", "Amazon", "All"]

  // Content
  pathLessons  PathLesson[]

  // User progress
  userProgress UserPathProgress[]

  // Milestones
  milestones   Milestone[]

  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([durationWeeks])
}

model PathLesson {
  id            String   @id @default(cuid())
  learningPathId String
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)

  lessonId      String
  lesson        Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Ordering and metadata
  weekNumber    Int     // Which week this lesson belongs to
  dayNumber     Int     // Which day of the week
  orderIndex    Int     // Order within the day

  isRequired    Boolean @default(true) // Optional vs required lessons
  estimatedHours Float  @default(1.0)

  createdAt     DateTime @default(now())

  @@unique([learningPathId, lessonId])
  @@index([learningPathId])
  @@index([lessonId])
  @@index([weekNumber, dayNumber])
}

model UserPathProgress {
  id            String   @id @default(cuid())
  userId        String
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  learningPathId String
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)

  // Progress tracking
  currentWeek   Int     @default(1)
  currentDay    Int     @default(1)
  completedLessons Int  @default(0)
  totalLessons  Int     @default(0)

  startedAt     DateTime @default(now())
  lastActivityAt DateTime @default(now())
  completedAt   DateTime?

  // User preferences
  isActive      Boolean @default(true) // User can pause/unpause paths

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, learningPathId])
  @@index([userId])
  @@index([learningPathId])
  @@index([isActive])
}

// ============ JOBS BOARD ============
model Job {
  id          String   @id @default(cuid())
  title       String
  company     String
  location    String?
  type        JobType
  experience  String   // "0-2 years", "2-5 years", etc.
  salary      String?  // "‚Çπ5-10 LPA", "$50-80K", etc.
  description String
  requirements String?
  externalUrl String   // Link to actual job posting
  isActive    Boolean  @default(true)

  postedBy    String   // Admin user ID
  postedByUser User    @relation(fields: [postedBy], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  FREELANCE
}

// ============ MILESTONES & ACHIEVEMENTS ============
model Milestone {
  id          String   @id @default(cuid())
  title       String   // "First Lesson Completed", "Week 1 Finished"
  description String
  emoji       String   @default("üéâ")

  // Trigger conditions
  type        MilestoneType
  threshold   Int      // Number of lessons, days, etc.
  pathSpecific Boolean @default(false) // Applies to specific paths only

  // Associated paths (if path-specific)
  learningPaths LearningPath[]

  // User achievements
  achievements Achievement[]

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([isActive])
}

model Achievement {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  milestoneId String
  milestone   Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  // Achievement details
  unlockedAt  DateTime @default(now())
  pathId      String?  // Which path this was achieved in (if applicable)

  @@unique([userId, milestoneId])
  @@index([userId])
  @@index([milestoneId])
  @@index([pathId])
}

enum MilestoneType {
  LESSONS_COMPLETED     // Total lessons completed
  CONSECUTIVE_DAYS      // Consecutive study days
  WEEK_COMPLETED        // Completed a full week
  PATH_COMPLETED        // Completed entire learning path
  STREAK_MAINTAINED     // Maintained study streak
  FIRST_LESSON          // Completed first lesson
  SPEED_LEARNER         // Completed multiple lessons in one day
}
