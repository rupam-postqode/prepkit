generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


model User {
  id                  String             @id @default(cuid())
  email               String             @unique
  passwordHash        String
  name                String
  role                Role               @default(USER)
  targetCompanies     String
  experienceLevel     Experience         @default(FRESHER)
  preferredLanguage   String             @default("javascript")
  subscriptionStatus  SubscriptionStatus @default(FREE)
  subscriptionPlan    String?
  subscriptionEndDate DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  lastLoginAt         DateTime?
  achievements        Achievement[]
  feedback            Feedback[]
  jobs                Job[]
  lessonProgress      LessonProgress[]
  subscriptions       Subscription[]
  pathProgress        UserPathProgress[]
  videos              Video[]
  resetHistory       ResetHistory[]
  interviewSessions   InterviewSession[]     @relation("InterviewSessions")
  interviewStatistics InterviewStatistics?   @relation("InterviewStatistics")
  interviewPayments  InterviewPayment[]

  @@index([email])
  @@index([subscriptionStatus])
}

model Module {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  description String
  emoji       String
  orderIndex  Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  chapters    Chapter[]
}

model Chapter {
  id              String     @id @default(cuid())
  moduleId        String
  title           String
  slug            String
  description     String
  orderIndex      Int
  difficultyLevel Difficulty @default(BEGINNER)
  estimatedHours  Int
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  module          Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lessons         Lesson[]

  @@unique([moduleId, slug])
  @@index([moduleId])
}

model Lesson {
  id               String           @id @default(cuid())
  chapterId        String
  title            String
  slug             String
  description      String
  orderIndex       Int
  videoUrl         String?
  videoDurationSec Int?
  markdownContent  String
  difficulty       Difficulty
  publishedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  premium          Boolean          @default(false)
  commonMistakes   String?
  importantPoints  String?
  quickReference   String?
  contentHash      String?
  encryptedContent String?
  encryptionIv     String?
  encryptionKey    String?
  encryptionTag    String?
  keyVersion       String?
  feedback         Feedback[]
  chapter          Chapter          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  progress         LessonProgress[]
  pathLessons      PathLesson[]
  practiceLinks    PracticeLink[]
  videos           Video[]

  @@unique([chapterId, slug])
  @@index([chapterId])
  @@index([publishedAt])
}

model LessonProgress {
  id                  String    @id @default(cuid())
  userId              String
  lessonId            String
  startedAt           DateTime  @default(now())
  completedAt         DateTime?
  timeSpentSeconds    Int       @default(0)
  videoWatchedPercent Int       @default(0)
  markdownRead        Boolean   @default(false)
  rating              Int?
  notes               String?
  updatedAt           DateTime  @updatedAt
  lesson              Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([completedAt])
}

model PracticeLink {
  id           String     @id @default(cuid())
  lessonId     String
  platform     Platform
  problemTitle String
  problemUrl   String
  difficulty   Difficulty
  orderIndex   Int
  createdAt    DateTime   @default(now())
  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model Feedback {
  id        String       @id @default(cuid())
  userId    String
  lessonId  String?
  rating    Int?
  comment   String
  type      FeedbackType
  createdAt DateTime     @default(now())
  lesson    Lesson?      @relation(fields: [lessonId], references: [id])
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([type])
}

model Video {
  id           String      @id @default(cuid())
  fileName     String
  originalName String
  fileSize     Int
  mimeType     String
  duration     Int?
  s3Key        String
  s3Bucket     String
  status       VideoStatus @default(UPLOADED)
  uploadedBy   String
  lessonId     String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  lesson       Lesson?     @relation(fields: [lessonId], references: [id])
  user         User        @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([uploadedBy])
  @@index([lessonId])
  @@index([status])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String
  plan                 SubscriptionPlan
  status               SubscriptionStatus
  stripeSubscriptionId String?            @unique
  stripeCustomerId     String?
  startDate            DateTime           @default(now())
  endDate              DateTime?
  amount               Int
  currency             String             @default("INR")
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  payments             Payment[]
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([endDate])
}

model Payment {
  id                    String        @id @default(cuid())
  subscriptionId        String?
  userId                String
  stripePaymentId       String?       @unique
  stripePaymentIntentId String
  amount                Int
  currency              String        @default("INR")
  status                PaymentStatus
  method                String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  subscription          Subscription? @relation(fields: [subscriptionId], references: [id])
  refunds               Refund[]

  @@index([userId])
  @@index([status])
}

model Refund {
  id             String       @id @default(cuid())
  paymentId      String
  stripeRefundId String       @unique
  amount         Int
  currency       String       @default("INR")
  status         RefundStatus @default(PROCESSED)
  reason         String?
  processedBy    String
  processedAt    DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  payment        Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
}

model LearningPath {
  id                String             @id @default(cuid())
  title             String
  slug              String             @unique
  description       String
  emoji             String             @default("ðŸŽ¯")
  durationWeeks     Int
  difficulty        Difficulty         @default(MEDIUM)
  targetCompanies   String
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  generatedFromJson String?
  isDynamic         Boolean            @default(false)
  lastGeneratedAt   DateTime?
  templateId        String?
  template          PathTemplate?      @relation(fields: [templateId], references: [id])
  
  // New timeline-specific fields
  pathType          PathType           @default(STANDARD)
  intensityLevel    Int                @default(2)
  estimatedHoursPerDay Float           @default(2.0)
  priorityTopics    Json?
  optionalContent   Json?
  
  pathLessons       PathLesson[]
  userProgress      UserPathProgress[]
  milestones        Milestone[]        @relation("LearningPathToMilestone")
  timelineMilestones TimelineMilestone[]
  resetHistory      ResetHistory[]

  @@index([isActive])
  @@index([durationWeeks])
  @@index([isDynamic])
  @@index([pathType])
}

model PathTemplate {
  id                   String         @id @default(cuid())
  name                 String
  description          String
  emoji                String         @default("ðŸŽ¯")
  durationWeeks        Int
  difficulty           Difficulty     @default(MEDIUM)
  targetAudience       String
  rules                Json
  includeModules       String
  excludeModules       String
  minDifficulty        Difficulty?
  maxDifficulty        Difficulty?
  lessonsPerDay        Int            @default(2)
  daysPerWeek          Int            @default(5)
  estimatedHoursPerDay Float          @default(2.0)
  isActive             Boolean        @default(true)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  generatedPaths       LearningPath[]

  @@index([isActive])
  @@index([durationWeeks])
}

model ContentMetadata {
  lessonId         String   @id
  difficultyScore  Float    @default(1.0)
  complexityScore  Float    @default(1.0)
  estimatedMinutes Int      @default(60)
  readingMinutes   Int      @default(30)
  practiceMinutes  Int      @default(30)
  topics           Json
  skills           Json
  prerequisites    Json
  companyRelevance Json
  objectives       Json
  contentType      String
  interactiveLevel String
  lastAnalyzedAt   DateTime @default(now())
  analysisVersion  String   @default("1.0")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([difficultyScore])
  @@index([complexityScore])
  @@index([contentType])
}

model PathLesson {
  id             String       @id @default(cuid())
  learningPathId String
  lessonId       String
  weekNumber     Int
  dayNumber      Int
  orderIndex     Int
  isRequired     Boolean      @default(true)
  estimatedHours Float        @default(1.0)
  createdAt      DateTime     @default(now())
  
  // New timeline-specific fields
  priority       Int          @default(2)
  isSkippable    Boolean      @default(false)
  dependencies   String
  masteryLevel   MasteryLevel @default(STANDARD)
  adaptiveContent Json?
  
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  lesson         Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  contentAdaptations ContentAdaptation[]

  @@unique([learningPathId, lessonId])
  @@index([learningPathId])
  @@index([lessonId])
  @@index([weekNumber, dayNumber])
  @@index([priority])
}

model UserPathProgress {
  id               String       @id @default(cuid())
  userId           String
  learningPathId   String
  currentWeek      Int          @default(1)
  currentDay       Int          @default(1)
  completedLessons Int          @default(0)
  totalLessons     Int          @default(0)
  startedAt        DateTime     @default(now())
  lastActivityAt   DateTime     @default(now())
  completedAt      DateTime?
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  // New timeline-specific fields
  targetInterviewDate    DateTime?
  originalTargetDate     DateTime?
  paceAdjustments       Json?
  timeSpentVsPlanned    Float?
  deadlineAlerts        Json?
  completedMilestones   String
  studyStreak           Int          @default(0)
  longestStreak         Int          @default(0)
  weeklyGoals           Json?
  
  learningPath     LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  studySessions     StudySession[]
  timelineAlerts    TimelineAlert[]

  @@unique([userId, learningPathId])
  @@index([userId])
  @@index([learningPathId])
  @@index([isActive])
  @@index([targetInterviewDate])
}

model Job {
  id           String   @id @default(cuid())
  title        String
  company      String
  location     String?
  type         JobType
  experience   String
  salary       String?
  description  String
  requirements String?
  externalUrl  String
  isActive     Boolean  @default(true)
  postedBy     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  postedByUser User     @relation(fields: [postedBy], references: [id])

  @@index([isActive])
  @@index([createdAt])
}

model Milestone {
  id            String         @id @default(cuid())
  title         String
  description   String
  emoji         String         @default("ðŸŽ‰")
  type          MilestoneType
  threshold     Int
  pathSpecific  Boolean        @default(false)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  achievements   Achievement[]
  learningPaths LearningPath[] @relation("LearningPathToMilestone")

  @@index([type])
  @@index([isActive])
}

model Achievement {
  id          String    @id @default(cuid())
  userId      String
  milestoneId String
  unlockedAt  DateTime  @default(now())
  pathId      String?
  milestone   Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, milestoneId])
  @@index([userId])
  @@index([milestoneId])
  @@index([pathId])
}

model ResetHistory {
  id         String       @id @default(cuid())
  userId     String
  type       ResetType
  pathId     String?
  weekNumber Int?
  reason     String
  timestamp  DateTime     @default(now())
  path       LearningPath? @relation(fields: [pathId], references: [id])
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
  @@index([pathId])
}

enum Role {
  USER
  ADMIN
}

enum Experience {
  FRESHER
  JUNIOR
  MID
  SENIOR
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
}

enum Difficulty {
  BEGINNER
  EASY
  MEDIUM
  HARD
}

enum Platform {
  LEETCODE
  CODESANDBOX
  ALGOEXPERT
  HACKERRANK
}

enum FeedbackType {
  BUG
  SUGGESTION
  GENERAL
}

enum VideoStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  FAILED
}

enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum RefundStatus {
  PENDING
  PROCESSED
  FAILED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  FREELANCE
}

enum MilestoneType {
  LESSONS_COMPLETED
  CONSECUTIVE_DAYS
  WEEK_COMPLETED
  PATH_COMPLETED
  STREAK_MAINTAINED
  FIRST_LESSON
  SPEED_LEARNER
}

enum ResetType {
  PATH
  WEEK
  ALL
}

// New enums for timeline-based learning paths
enum PathType {
  STANDARD
  TIMELINE_1_MONTH
  TIMELINE_3_MONTHS
  TIMELINE_6_MONTHS
  CUSTOM
}

enum MasteryLevel {
  BASIC          // For 1-month timeline - just enough to pass
  STANDARD       // For 3-month timeline - good understanding
  ADVANCED       // For 6-month timeline - deep mastery
}

// New models for timeline features
model TimelineMilestone {
  id              String       @id @default(cuid())
  learningPathId  String
  title           String
  description     String
  emoji           String       @default("ðŸŽ‰")
  targetDate      DateTime
  bufferDays      Int          @default(0)
  isCritical      Boolean      @default(false)
  type            MilestoneType
  threshold       Int
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  learningPath    LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)

  @@index([learningPathId])
  @@index([targetDate])
  @@index([isCritical])
}

model StudySession {
  id               String    @id @default(cuid())
  userId           String
  userPathProgressId String
  startTime         DateTime  @default(now())
  endTime           DateTime?
  lessonsStudied   String
  topicsCovered     String
  timeSpent        Int       @default(0)
  focusScore       Int       @default(0)
  comprehensionScore Int       @default(0)
  interruptions    Int       @default(0)
  effectiveness    Int       @default(0)
  deviceType       String?
  location         String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  userPathProgress UserPathProgress @relation(fields: [userPathProgressId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userPathProgressId])
  @@index([startTime])
  @@index([effectiveness])
}

model ContentAdaptation {
  id             String       @id @default(cuid())
  lessonId       String
  pathType       PathType
  masteryLevel   MasteryLevel
  adaptedContent Json
  estimatedTime  Int
  priority       Int          @default(2)
  isSkippable    Boolean      @default(false)
  learningObjectives String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  pathLesson     PathLesson?  @relation(fields: [lessonId], references: [id])

  @@index([lessonId])
  @@index([pathType])
  @@index([masteryLevel])
  @@index([priority])
}

model PaceAdjustment {
  id                 String @id @default(cuid())
  userPathProgressId  String
  adjustmentType     String
  oldPace            Float?
  newPace            Float?
  reason             String?
  impact             String?
  automatic          Boolean @default(false)
  createdAt          DateTime @default(now())


  @@index([userPathProgressId])
  @@index([createdAt])
}

// Mock Interview Models
model InterviewSession {
  id                  String              @id @default(cuid())
  userId              String
  type                InterviewType
  difficulty          InterviewDifficulty
  status              InterviewStatus     @default(SETUP)
  
  // Vapi Integration
  vapiCallId          String?             @unique
  vapiSessionId       String?
  vapiRecordingUrl    String?
  
  // Timing
  createdAt           DateTime            @default(now())
  startedAt           DateTime?
  endedAt             DateTime?
  durationSeconds     Int?
  
  // Configuration & Questions
  configuration       Json                // {focusAreas, requirements, duration}
  questionsGenerated   Json                // Full questions array
  
  // Results
  reportGenerated      Boolean             @default(false)
  costCalculated      Float?               // Changed from Decimal to Float for compatibility
  paymentStatus       PaymentStatus?      @default(CREATED)
  
  // Metadata
  metadata            Json?
  updatedAt           DateTime            @updatedAt
  
  // Relations
  user                User                @relation("InterviewSessions", fields: [userId], references: [id], onDelete: Cascade)
  questions           InterviewQuestion[]
  transcript          InterviewTranscript?
  report              InterviewReport?
  payment             InterviewPayment?
  statistics          InterviewStatistics?     @relation("InterviewStatistics")
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([type])
  @@index([difficulty])
}

model InterviewQuestion {
  id                  String              @id @default(cuid())
  sessionId           String
  questionOrder        Int
  questionId          String?
  questionText        String
  difficulty          Int?
  expectedKeyPoints   Json                 // Changed from String[] to Json for compatibility
  
  // User Response
  userResponseText     String?
  userResponseDuration Int?                // seconds
  responseScore       Int?                 // Removed @db.SmallInt for compatibility
  
  // Follow-ups
  followUpAsked       Boolean             @default(false)
  followUpQuestions   Json                 // Changed from String[] to Json for compatibility
  
  metadata            Json?
  createdAt           DateTime            @default(now())
  
  // Relations
  session             InterviewSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, questionOrder])
  @@index([sessionId])
}

model InterviewTranscript {
  id                  String              @id @default(cuid())
  sessionId           String              @unique
  rawTranscript       String
  transcriptSegments   Json?               // Parsed Q&A pairs
  confidenceScore     Float?
  
  createdAt           DateTime            @default(now())
  
  // Relations
  session             InterviewSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
}

model InterviewReport {
  id                  String              @id @default(cuid())
  sessionId           String              @unique
  
  // Scoring
  overallScore        Int?                 // Removed @db.SmallInt for compatibility
  scoreBreakdown      Json?               // {technicalDepth, communication, problemSolving, etc}
  
  // Analysis
  strengths           Json                 // Changed from String[] to Json for compatibility
  weaknesses          Json                 // Changed from String[] to Json for compatibility
  recommendations     Json                 // Changed from String[] to Json for compatibility
  detailedAnalysis    String?
  
  // Comparison
  averageScoreForDifficulty Int?         // Removed @db.SmallInt for compatibility
  topPerformerScore   Int?                 // Removed @db.SmallInt for compatibility
  percentileRank      Int?                 // Removed @db.SmallInt for compatibility
  
  // Generated Content
  reportJson          Json
  
  generatedAt         DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  // Relations
  session             InterviewSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
}

model InterviewStatistics {
  id                  String              @id @default(cuid())
  userId              String              @unique
  sessionId           String?             @unique
  
  totalInterviews     Int                 @default(0)
  totalSpent          Float?               @default(0) // Changed from Decimal to Float for compatibility
  averageScore        Int?                 // Removed @db.SmallInt for compatibility
  
  // By type
  javascriptInterviews Int                 @default(0)
  machinecodingInterviews Int              @default(0)
  dsaInterviews       Int                 @default(0)
  systemdesignInterviews Int               @default(0)
  behavioralInterviews Int                 @default(0)
  
  // Progress
  lastInterviewAt     DateTime?
  bestScoreAchieved   Int?                 // Removed @db.SmallInt for compatibility
  improvementTrend    Int?                 // Removed @db.SmallInt for compatibility
  
  updatedAt           DateTime            @updatedAt
  
  // Relations
  user                User                @relation("InterviewStatistics", fields: [userId], references: [id], onDelete: Cascade)
  session             InterviewSession?     @relation("InterviewStatistics", fields: [sessionId], references: [id])
  
  @@index([userId])
}

model InterviewPayment {
  id                  String              @id @default(cuid())
  userId              String
  sessionId           String              @unique // Added unique for one-to-one relationship
  
  amount              Float               // Changed from Decimal to Float for compatibility
  currency            String              @default("INR")
  status              PaymentStatus       @default(CREATED)
  
  paymentMethodId     String?             // Stripe/Razorpay ID
  transactionId       String?             @unique
  
  createdAt           DateTime            @default(now())
  completedAt         DateTime?
  
  // Relations
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  session             InterviewSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([status])
}

// New enums
enum InterviewType {
  JAVASCRIPT
  MACHINE_CODING
  DSA
  SYSTEM_DESIGN
  BEHAVIORAL
}

enum InterviewDifficulty {
  EASY
  MEDIUM
  HARD
  EXPERT
}

enum InterviewStatus {
  SETUP
  IN_PROGRESS
  COMPLETED
  FAILED
}

model TimelineAlert {
  id                 String @id @default(cuid())
  userPathProgressId  String
  alertType          String
  severity            String
  message            String
  isRead             Boolean @default(false)
  actionRequired      Boolean @default(false)
  actionUrl          String?
  scheduledFor       DateTime?
  sentAt             DateTime?
  createdAt          DateTime @default(now())

  userPathProgress UserPathProgress @relation(fields: [userPathProgressId], references: [id], onDelete: Cascade)

  @@index([userPathProgressId])
  @@index([isRead])
  @@index([scheduledFor])
}
