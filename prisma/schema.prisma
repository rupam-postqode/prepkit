generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String             @id @default(cuid())
  email               String             @unique
  passwordHash        String
  name                String
  role                Role               @default(USER)
  targetCompanies     String[]
  experienceLevel     Experience         @default(FRESHER)
  preferredLanguage   String             @default("javascript")
  subscriptionStatus  SubscriptionStatus @default(FREE)
  subscriptionPlan    String?
  subscriptionEndDate DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  lastLoginAt         DateTime?
  achievements        Achievement[]
  feedback            Feedback[]
  jobs                Job[]
  lessonProgress      LessonProgress[]
  subscriptions       Subscription[]
  pathProgress        UserPathProgress[]
  videos              Video[]

  @@index([email])
  @@index([subscriptionStatus])
}

model Module {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  description String
  emoji       String
  orderIndex  Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  chapters    Chapter[]
}

model Chapter {
  id              String     @id @default(cuid())
  moduleId        String
  title           String
  slug            String
  description     String
  orderIndex      Int
  difficultyLevel Difficulty @default(BEGINNER)
  estimatedHours  Int
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  module          Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  lessons         Lesson[]

  @@unique([moduleId, slug])
  @@index([moduleId])
}

model Lesson {
  id               String           @id @default(cuid())
  chapterId        String
  title            String
  slug             String
  description      String
  orderIndex       Int
  videoUrl         String?
  videoDurationSec Int?
  markdownContent  String
  difficulty       Difficulty
  publishedAt      DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  premium          Boolean          @default(false)
  commonMistakes   String?
  importantPoints  String?
  quickReference   String?
  contentHash      String?
  encryptedContent String?
  encryptionIv     String?
  encryptionKey    String?
  encryptionTag    String?
  keyVersion       String?
  feedback         Feedback[]
  chapter          Chapter          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  progress         LessonProgress[]
  pathLessons      PathLesson[]
  practiceLinks    PracticeLink[]
  videos           Video[]

  @@unique([chapterId, slug])
  @@index([chapterId])
  @@index([publishedAt])
}

model LessonProgress {
  id                  String    @id @default(cuid())
  userId              String
  lessonId            String
  startedAt           DateTime  @default(now())
  completedAt         DateTime?
  timeSpentSeconds    Int       @default(0)
  videoWatchedPercent Int       @default(0)
  markdownRead        Boolean   @default(false)
  rating              Int?
  notes               String?
  updatedAt           DateTime  @updatedAt
  lesson              Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([completedAt])
}

model PracticeLink {
  id           String     @id @default(cuid())
  lessonId     String
  platform     Platform
  problemTitle String
  problemUrl   String
  difficulty   Difficulty
  orderIndex   Int
  createdAt    DateTime   @default(now())
  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model Feedback {
  id        String       @id @default(cuid())
  userId    String
  lessonId  String?
  rating    Int?
  comment   String
  type      FeedbackType
  createdAt DateTime     @default(now())
  lesson    Lesson?      @relation(fields: [lessonId], references: [id])
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lessonId])
  @@index([type])
}

model Video {
  id           String      @id @default(cuid())
  fileName     String
  originalName String
  fileSize     Int
  mimeType     String
  duration     Int?
  s3Key        String
  s3Bucket     String
  status       VideoStatus @default(UPLOADED)
  uploadedBy   String
  lessonId     String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  lesson       Lesson?     @relation(fields: [lessonId], references: [id])
  user         User        @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([uploadedBy])
  @@index([lessonId])
  @@index([status])
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String
  plan                   SubscriptionPlan
  status                 SubscriptionStatus
  razorpaySubscriptionId String?            @unique
  razorpayCustomerId     String?
  startDate              DateTime           @default(now())
  endDate                DateTime?
  amount                 Int
  currency               String             @default("INR")
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  payments               Payment[]
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([endDate])
}

model Payment {
  id                String        @id @default(cuid())
  subscriptionId    String?
  userId            String
  razorpayPaymentId String?       @unique
  razorpayOrderId   String
  amount            Int
  currency          String        @default("INR")
  status            PaymentStatus
  method            String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  refunds           Refund[]

  @@index([userId])
  @@index([status])
}

model Refund {
  id               String       @id @default(cuid())
  paymentId        String
  razorpayRefundId String       @unique
  amount           Int
  currency         String       @default("INR")
  status           RefundStatus @default(PROCESSED)
  reason           String?
  processedBy      String
  processedAt      DateTime     @default(now())
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  payment          Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
}

model LearningPath {
  id                String             @id @default(cuid())
  title             String
  slug              String             @unique
  description       String
  emoji             String             @default("ðŸŽ¯")
  durationWeeks     Int
  difficulty        Difficulty         @default(MEDIUM)
  targetCompanies   String[]
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  generatedFromJson String?
  isDynamic         Boolean            @default(false)
  lastGeneratedAt   DateTime?
  templateId        String?
  template          PathTemplate?      @relation(fields: [templateId], references: [id])
  pathLessons       PathLesson[]
  userProgress      UserPathProgress[]
  milestones        Milestone[]        @relation("LearningPathToMilestone")

  @@index([isActive])
  @@index([durationWeeks])
  @@index([isDynamic])
}

model PathTemplate {
  id                   String         @id @default(cuid())
  name                 String
  description          String
  emoji                String         @default("ðŸŽ¯")
  durationWeeks        Int
  difficulty           Difficulty     @default(MEDIUM)
  targetAudience       String
  rules                Json
  includeModules       String[]
  excludeModules       String[]
  minDifficulty        Difficulty?
  maxDifficulty        Difficulty?
  lessonsPerDay        Int            @default(2)
  daysPerWeek          Int            @default(5)
  estimatedHoursPerDay Float          @default(2.0)
  isActive             Boolean        @default(true)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  generatedPaths       LearningPath[]

  @@index([isActive])
  @@index([durationWeeks])
}

model ContentMetadata {
  lessonId         String   @id
  difficultyScore  Float    @default(1.0)
  complexityScore  Float    @default(1.0)
  estimatedMinutes Int      @default(60)
  readingMinutes   Int      @default(30)
  practiceMinutes  Int      @default(30)
  topics           Json
  skills           Json
  prerequisites    Json
  companyRelevance Json
  objectives       Json
  contentType      String
  interactiveLevel String
  lastAnalyzedAt   DateTime @default(now())
  analysisVersion  String   @default("1.0")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([difficultyScore])
  @@index([complexityScore])
  @@index([contentType])
}

model PathLesson {
  id             String       @id @default(cuid())
  learningPathId String
  lessonId       String
  weekNumber     Int
  dayNumber      Int
  orderIndex     Int
  isRequired     Boolean      @default(true)
  estimatedHours Float        @default(1.0)
  createdAt      DateTime     @default(now())
  learningPath   LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  lesson         Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([learningPathId, lessonId])
  @@index([learningPathId])
  @@index([lessonId])
  @@index([weekNumber, dayNumber])
}

model UserPathProgress {
  id               String       @id @default(cuid())
  userId           String
  learningPathId   String
  currentWeek      Int          @default(1)
  currentDay       Int          @default(1)
  completedLessons Int          @default(0)
  totalLessons     Int          @default(0)
  startedAt        DateTime     @default(now())
  lastActivityAt   DateTime     @default(now())
  completedAt      DateTime?
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  learningPath     LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, learningPathId])
  @@index([userId])
  @@index([learningPathId])
  @@index([isActive])
}

model Job {
  id           String   @id @default(cuid())
  title        String
  company      String
  location     String?
  type         JobType
  experience   String
  salary       String?
  description  String
  requirements String?
  externalUrl  String
  isActive     Boolean  @default(true)
  postedBy     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  postedByUser User     @relation(fields: [postedBy], references: [id])

  @@index([isActive])
  @@index([createdAt])
}

model Milestone {
  id            String         @id @default(cuid())
  title         String
  description   String
  emoji         String         @default("ðŸŽ‰")
  type          MilestoneType
  threshold     Int
  pathSpecific  Boolean        @default(false)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  achievements  Achievement[]
  learningPaths LearningPath[] @relation("LearningPathToMilestone")

  @@index([type])
  @@index([isActive])
}

model Achievement {
  id          String    @id @default(cuid())
  userId      String
  milestoneId String
  unlockedAt  DateTime  @default(now())
  pathId      String?
  milestone   Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, milestoneId])
  @@index([userId])
  @@index([milestoneId])
  @@index([pathId])
}

enum Role {
  USER
  ADMIN
}

enum Experience {
  FRESHER
  JUNIOR
  MID
  SENIOR
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  YEARLY
  LIFETIME
}

enum Difficulty {
  BEGINNER
  EASY
  MEDIUM
  HARD
}

enum Platform {
  LEETCODE
  CODESANDBOX
  ALGOEXPERT
  HACKERRANK
}

enum FeedbackType {
  BUG
  SUGGESTION
  GENERAL
}

enum VideoStatus {
  UPLOADED
  PROCESSING
  PROCESSED
  FAILED
}

enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum RefundStatus {
  PENDING
  PROCESSED
  FAILED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  FREELANCE
}

enum MilestoneType {
  LESSONS_COMPLETED
  CONSECUTIVE_DAYS
  WEEK_COMPLETED
  PATH_COMPLETED
  STREAK_MAINTAINED
  FIRST_LESSON
  SPEED_LEARNER
}
